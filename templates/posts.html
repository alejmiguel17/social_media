{% extends '_base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/posts.css' %}">
{% endblock %}


{% block content %}
<h2>Publicaciones</h2>

<form method="post" enctype="multipart/form-data" action="{% url 'upload-post' %}">
    {% csrf_token %}
    <label for="image_upload">Imagen:</label>
    <input type="file" name="image_upload" id="image_upload" required>
    <br>
    <label for="caption">Descripci√≥n:</label>
    <textarea name="caption" id="caption" required></textarea>
    <br>
    <button type="submit">Publicar</button>
</form>
<hr>

{% for post in posts %}
    <div class="post">
        <p><strong>{{ post.user }}</strong></p>
        <img src="{{ post.image.url }}" alt="Imagen del post" style="max-width:300px;">
        <p>{{ post.caption }}</p>
        <p><small>{{ post.created_at }}</small></p>

<!-- ---------------------------------------------- -->
<!-- Sistema de likes #JD 14 08                    -->
        <div>
            <form class="like-form" method="POST" data-post-id="{{ post.id }}">
                {% csrf_token %}
                <button type="submit" class="like-btn" id="like-btn-{{ post.id }}">
                    ‚ù§Ô∏è Me gusta
                </button>
                <span id="likes-count-{{ post.id }}">{{ post.likes_count }}</span>
            </form>
        </div>
<!-- ---------------------------------------------- -->

        <hr>
    </div>
{% empty %}
    <p>Tu feed est√° vac√≠o. ¬°Empieza a seguir a otros usuarios para ver sus publicaciones!</p>
{% endfor %}

<!-- Sugerencias de usuarios -->
{% if suggestions %}
    <h3>Sugerencias para seguir:</h3>
    <ul>
        {% for user in suggestions %}
            <li>
                <a href="{% url 'profile' user.username %}">{{ user.username }}</a>
            </li>
        {% endfor %}
    </ul>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.like-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const postId = form.dataset.postId;
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
            const button = document.getElementById(`like-btn-${postId}`);
            const countSpan = document.getElementById(`likes-count-${postId}`);

            fetch(`/like/${postId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Accept': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                button.textContent = data.liked ? 'üíî Quitar Me gusta' : '‚ù§Ô∏è Me gusta';
                countSpan.textContent = data.likes_count;
            })
            .catch(error => {
                console.error('Error al dar Me gusta:', error);
            });
        });
    });
});
</script>
{% endblock %}
