{% extends '_base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<h2>Perfil de {{ profile_user.username }}</h2>

<div class="profile-info">
    {% if profile.profile_picture %}
        <img src="{{ profile.profile_picture.url }}" alt="Foto de perfil" style="max-width:150px;">
    {% else %}
        <img src="{% static 'img/default_profile.png' %}" alt="Foto por defecto" style="max-width:150px;">
    {% endif %}
    <p><strong>Bio:</strong> {{ profile.bio|default:"Sin biografía" }}</p>
    <p><strong>Ubicación:</strong> {{ profile.location|default:"No especificada" }}</p>
    <p><strong>Seguidores:</strong> <span id="followers-count">{{ followers }}</span></p>
    <p><strong>Seguidos:</strong> {{ following }}</p>

    {% if request.user.username != profile_user.username %}
        <button type="button"
                id="follow-btn"
                data-user-id="{{ profile_user.id }}">
            {% if is_following %}
                Dejar de seguir
            {% else %}
                Seguir
            {% endif %}
        </button>
    {% endif %}
</div>

<hr>

<h3>Publicaciones de {{ profile_user.username }}</h3>
{% for post in posts %}
    <div class="post" id="post-{{ post.id }}">
        <img src="{{ post.image.url }}" alt="Imagen del post" style="max-width:300px;">
        <p>{{ post.caption }}</p>
        <p><small>{{ post.created_at }}</small></p>

        {% if post.user == request.user or request.user.is_superuser %}
            <!-- <button class="delete-btn" data-post-id="{{ post.id }}">Eliminar</button> -->
            <a href="{% url 'delete_post' post.id %}" class="delete-btn">Eliminar</a>
            {% endif %}

        <hr>
    </div>
{% empty %}
    <p>Este usuario no ha publicado nada aún.</p>
{% endfor %}
    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
{% endblock %}



{% block extra_js %}
<script>
	document.addEventListener('DOMContentLoaded', () => {
		const followBtn = document.getElementById('follow-btn');
		const followersCount = document.getElementById('followers-count');
		const csrfToken = document.getElementById('csrf-token')?.value;

		if (!followBtn || !csrfToken) return;

		followBtn.addEventListener('click', () => {
			const userId = followBtn.dataset.userId;

			fetch('/follow-toggle/', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': csrfToken,
					'Accept': 'application/json'
				},
				body: JSON.stringify({ user_id: userId })
			})
				.then(response => {
					if (!response.ok) throw new Error('Error al seguir');
					return response.json();
				})
				.then(data => {
					if (data.status === 'success') {
						followBtn.textContent = data.is_following ? 'Dejar de seguir' : 'Seguir';
						followersCount.textContent = data.followers_count;
					}
				})
				.catch(error => {
					console.error('Error:', error);
				});
		});
	});
</script>
{% endblock %}
