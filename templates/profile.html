{% extends '_base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<h2>Perfil de {{ profile_user.username }}</h2>

<div class="profile-info">
    {% if profile.profile_picture %}
        <img src="{{ profile.profile_picture.url }}" alt="Foto de perfil" style="max-width:150px;">
    {% else %}
        <img src="{% static 'img/default_profile.png' %}" alt="Foto por defecto" style="max-width:150px;">
    {% endif %}
    <p><strong>Bio:</strong> {{ profile.bio|default:"Sin biograf√≠a" }}</p>
    <p><strong>Ubicaci√≥n:</strong> {{ profile.location|default:"No especificada" }}</p>
    <p><strong>Seguidores:</strong> <span id="followers-count">{{ followers }}</span></p>
    <p><strong>Seguidos:</strong> {{ following }}</p>

    {% if request.user.username != profile_user.username %}
        <form id="follow-form" method="POST" action="{% url 'follow_user' profile_user.id %}">
            {% csrf_token %}
            <input type="hidden" name="following" value="{{ profile_user.username }}">
            <button type="submit" id="follow-btn">
                {% if is_following %}
                    Dejar de seguir
                {% else %}
                    Seguir
                {% endif %}
            </button>
        </form>
    {% endif %}
</div>

<hr>

<h3>Publicaciones de {{ profile_user.username }}</h3>
{% for post in posts %}
    <div class="post">
        <img src="{{ post.image.url }}" alt="Imagen del post" style="max-width:300px;">
        <p>{{ post.caption }}</p>
        <p><small>{{ post.created_at }}</small></p>

        {% if post.user == request.user or request.user.is_superuser %}
            <form method="POST" action="{% url 'delete_post' post.id %}">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('¬øEliminar este post?')">üóëÔ∏è Eliminar</button>
            </form>
        {% endif %}

        <hr>
    </div>
{% empty %}
    <p>Este usuario no ha publicado nada a√∫n.</p>
{% endfor %}
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('follow-form');
    const button = document.getElementById('follow-btn');
    const followersCount = document.getElementById('followers-count');

    if (form && button) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Accept': 'application/json',
                },
                body: new FormData(form)
            })
            .then(response => {
                if (!response.ok) throw new Error('Error en la petici√≥n');
                return response.json();
            })
            .then(data => {
                button.textContent = data.is_following ? 'Dejar de seguir' : 'Seguir';
                if (followersCount) {
                    followersCount.textContent = data.followers_count;
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    }
});
</script>
{% endblock %}